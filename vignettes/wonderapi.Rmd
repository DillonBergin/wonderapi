---
title: "Introduction to wonderapi"
author: "Joyce Robbins"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to wonderapi}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE)
```


## Introduction
This package makes it easier to use the CDC Wonder API.  It does so by employing hidden default query lists and lookup tables, allowing users to focus only on the variables they're interested in obtaining, and to write queries using human reading (English) names rather than numeric codes.

The best way to become familiar with CDC Wonder API options is to use the web interface: [https://wonder.cdc.gov](https://wonder.cdc.gov), as the options available through the API are nearly identical. The greatest difference is that location variables are not available through the API.  

## Understanding the structure of a query  

Queries are composed of parameter name-value pairs. There are different types of parameters.  Most critical are Group Results By and Measures. The Group Results By parameters serve as keys for grouping the data; the maximum number of Group Results By parameters is five.  Setting up a query without assistance is complex because the query must be submitted as an .xml file with a long list of required parameters, such as [here (Example 1)](https://wonder.cdc.gov/wonder/help/API-Examples/D76_Example1-req.xml) and [here (Example 2)](https://wonder.cdc.gov/wonder/help/API-Examples/D76_Example2-req.xml). 

## Codebooks

Codebooks are provided as package vignettes to allow the user to conveniently look up the names and values of available parameters in each dataset.  The codebooks are an important contribution of the package and are not provided by the CDC.  They are generated automatically by [this script](https://github.com/socdataR/wonderapi/blob/develop/R/make_codebook_vignette.R), which scrapes the CDC Wonder web interface form, and displays parameter names and values in human readable form.  The benefit of this method is the ability to quickly produce and update codebook vignettes that closely follow the web interface, with parameters appearing in the same order.  It also means, however, that the codebooks contain more information than the typical user needs to submit a query.  Most users will only need to group by variables (codes beginning with "B_"), measures (codes beginning with "M_"), and limiting variables (codes beginning with "V_"). 

Although some of the parameter names are long and/or awkward, for the sake of consistency, we follow the CDC names exactly. **The only exception is that any content that appears in parentheses should be dropped.** For example, "Fertility Rate" can be substituted for "M_5", but "Fertility Rate (Census Region, Census Division, HHS Region, State, County, Year, Age of Mother, Race) cannot.

Currently, the following codebook vignettes are available:

[Births dataset](D66codebook.html)

\link{getData}

**CHECK LOCATION** 
\link{D66Codebooks are available} 

## Default query lists and requests  

To facilitate the process of designing a query list, this package relies on default query lists. Each default query is set to request a single Group By Results parameter, generally set to `"Year"`. It is set to request the measures that are listed as default measures on the web interface (i.e. `Births` for [the Births dataset](https://wonder.cdc.gov/controller/datarequest/D76); `Deaths`, `Population` and `Crude Rate` for the [Detailed Mortality dataset](https://wonder.cdc.gov/controller/datarequest/D76).) To see the default settings, perform a query request without specifying a querylist:  

```{r}
library(dplyr)
library(wonderapi)
getData(TRUE, "Births") %>% head()
getData(TRUE, "Detailed Mortality") %>% head()
```

## Customized queries  
To make changes to the default list, first create a list of lists, wherein each nested list is a name-value pair.  For example, the following changes the first (and currently only) "Group Results By" variable to Weekday:

```{r, eval = FALSE}
mylist <- list(list("Group Results By", "Weekday"))
getData(TRUE, "Detailed Mortality", mylist) %>% head()
```

As the set up is slightly different depending on the parameter type, more details on setting up the name-value pairs by parameter types are provided below.

### Group By Variables  

Each dataset allows for five group by variables, codes for which are `"B_1", "B_2", "B_3", "B_4",` and `"B_5"`.  `"Group By Results"` may be substituted for `"B_1"` and `"And By"` for `"B_2"`. `"B_3"` through `"B_5"` may not be substituted to avoid ambiguity (this may change in the future.) Values -- in this case, the group by variables -- may be specified by code or human readable name. The following, thus, are equivalent:

```{r, eval = FALSE}
## not run
mylist <- list(list("B_1", "D66.V2"))
mylist <- list(list("Group Results By", "Race"))
mylist <- list(list("B_1", "Race"))
mylist <- list(list("Group Results By", "D66.V2"))
```

See the appropriate **codebook** for all group by options.  

### Measures
Measures do not need values; it is sufficient to specify a name only:

```{r}
mylist <- list(list("Group Results By", "Marital Status"),
               list("Average Age of Mother", "D66.M70"),
               list("sdfasdf", "sadf"))
mydata <- getData(TRUE, "Births", mylist)
```

```{r}
mylist <- list(list("Group Results By", "Marital Status"),
               list("Average Age of Mother", "D66.M70"),
               list("Year", "2015"))
getData(TRUE, "Births", mylist)
```

```{r}
mylist <- list(list("Group Results By", "Marital Status"),
               list("And By", "Year"),
               list("Average Age of Mother", ""))
mydata <- getData(TRUE, "Births", mylist)
knitr::kable(mydata)
```


By returning a tidy data frame, the query results are ready to be plotted without any additional data manipulation:  

```{r}
library(ggplot2)
ggplot(mydata, aes(x = Year, y = Births, 
                   color = `Marital Status`)) + 
    geom_line() + ggtitle("Births by Marital Status")

ggplot(mydata, aes(x = Year, y = `Average Age of Mother`,
                   color = `Marital Status`)) + geom_line() + geom_point() +
    ylab("age (in years)") + ggtitle("Average Age of Mother")

```

```{r}
library(tidyr)
mydata2 <- mydata %>% 
    select(-`Average Age of Mother`) %>% 
    spread(key = `Marital Status`, value = `Births`) %>% 
    mutate(Total = Married + Unmarried)
ggplot(mydata2, aes(x = Year, y = Unmarried / Total)) + geom_line() +
    geom_point() + ggtitle("Births to Unmarried Mothers as % of Total") +
    ylab("Percent of Total Births")
```


```{r eval = FALSE, echo = FALSE}
To do: check that names & values are recognized
```




Next, please read the documentation for the single function of the package {getData}. This vignette focuses on setting up the `querylist` parameter passed to this function. The `querylist`

